<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Hand ROM Analyzer（2指グループ固定）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
/* （CSSはあなたのものを完全保持） */
body{font-family:system-ui;background:#111;color:#eee;margin:0;padding:16px;}
h1{font-size:18px;margin:0 0 8px 0;}
#guide{font-size:13px;background:#222;padding:10px;border-radius:8px;margin-bottom:10px;}
#controls{margin-bottom:10px;}
#result{margin-top:10px;padding:10px;background:#1c1c1c;border-radius:8px;line-height:1.5;}
#hud{position:fixed;top:8px;left:8px;font-size:11px;color:#9f9;}
#buildTag{position:fixed;top:26px;left:8px;font-size:10px;color:#6f6;}
#buttons{position:fixed;right:12px;bottom:12px;display:flex;gap:10px;}
button{background:#333;color:#fff;border:none;padding:10px 12px;border-radius:8px;font-size:13px;}
button:hover{background:#555;}
#joaPanel{display:none;position:fixed;right:12px;bottom:70px;background:#222;padding:12px;border-radius:8px;font-size:12px;}
table{width:100%;border-collapse:collapse;margin-top:6px;}
td,th{border:1px solid #555;padding:3px;text-align:center;}
</style>
</head>

<body>

<h1>手指 可動域解析（動画・2指固定）</h1>

<!-- UI部：完全保持（省略せず原文通り） -->
<!-- …（中略：あなたのHTMLそのまま）… -->

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<script>
/* ===== Debug ===== */
const INDEX_ID = "index_12ROMn_SAFE_VIDEOLOOP_2026-01-02";
const BUILD_TIME = new Date().toISOString();
let DEBUG_LOG=[];

function log(m){
  const t=new Date().toLocaleTimeString();
  DEBUG_LOG.push(`[${t}] ${m}`);
  document.getElementById("hud").innerText=m;
}
function copyDebugLog(){
  navigator.clipboard.writeText(DEBUG_LOG.join("\n"));
  alert("ログをコピーしました");
}
function toggleJOA(){
  const p=document.getElementById("joaPanel");
  p.style.display=(p.style.display==="none")?"block":"none";
}
document.getElementById("buildTag").innerText =
  `INDEX-ID: ${INDEX_ID} / BUILD: ${BUILD_TIME}`;
</script>

<script>
/* ===== video / hands 初期化 ===== */
window.video = document.createElement("video");
video.muted = true;
video.playsInline = true;
video.loop = false;

window.hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

hands.onResults(res=>{
  if(res.multiHandLandmarks){
    window.lastLandmarks = res.multiHandLandmarks[0];
  }
});

let running = false;

/* ★ MediaPipe に動画フレームを送り続けるループ */
async function processFrame(){
  if(!running) return;
  if(video.readyState >= 2){
    await hands.send({image: video});
  }
  requestAnimationFrame(processFrame);
}

log("index initialized: video & hands ready");
</script>

<script src="analyze.js"></script>

<script>
function runAnalyze(mode){
  const file=document.getElementById("videoInput").files[0];
  if(!file){
    log("no video selected");
    return;
  }

  window.selectedGroup =
    document.querySelector('input[name="group"]:checked').value;

  video.src = URL.createObjectURL(file);

  video.onloadedmetadata = async ()=>{
    log("video metadata loaded");
    await video.play();                 // ★ 必須
    running = true;
    processFrame();                     // ★ 解析ループ開始
    log(`UI call → safeAnalyze(${mode})`);
    safeAnalyze(mode);
  };
}
</script>

</body>
</html>
